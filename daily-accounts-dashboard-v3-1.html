<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daily Accounts Dashboard - A to Z Packers & Movers</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    .tab-active { background: linear-gradient(135deg, #10b981, #059669); color: white; }
    .expense-card { border-left: 4px solid #ef4444; }
    .income-card { border-left: 4px solid #10b981; }
    .summary-card { background: linear-gradient(135deg, #1e293b, #334155); }
  </style>
</head>
<body class="bg-slate-100 min-h-screen">
  <div class="sticky top-0 z-50 bg-white shadow-lg border-b-4 border-blue-600">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex flex-col sm:flex-row justify-between items-center">
        <div class="text-center sm:text-left mb-2 sm:mb-0">
          <h1 class="text-2xl font-bold text-slate-800">A to Z Packers & Movers</h1>
          <p class="text-slate-600">Daily Accounts Dashboard</p>
        </div>
        <div class="text-center sm:text-right">
          <p class="text-lg font-semibold text-slate-800" id="currentDate"></p>
          <p class="text-sm text-slate-600">Manual Settlement ‚Ä¢ Opening Balance supported</p>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-4 py-6">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-indigo-500">
        <h3 class="text-lg font-semibold text-slate-700 mb-2">Opening Balance</h3>
        <p class="text-3xl font-bold text-indigo-600" id="openingBalanceText">‚Çπ0</p>
      </div>
      <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-red-500">
        <h3 class="text-lg font-semibold text-slate-700 mb-2">Total Expenses</h3>
        <p class="text-3xl font-bold text-red-600" id="totalExpenses">‚Çπ0</p>
      </div>
      <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-green-500">
        <h3 class="text-lg font-semibold text-slate-700 mb-2">Total Income</h3>
        <p class="text-3xl font-bold text-green-600" id="totalIncome">‚Çπ0</p>
      </div>
      <div class="summary-card rounded-2xl shadow-lg p-6 text-white">
        <h3 class="text-lg font-semibold mb-2">Net Balance (Closing)</h3>
        <p class="text-3xl font-bold" id="netBalance">‚Çπ0</p>
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow-lg mb-6">
      <div class="flex border-b overflow-x-auto">
        <button class="tab-button flex-1 py-4 px-6 font-semibold rounded-tl-2xl tab-active" data-tab="expenses">üìä Expenses</button>
        <button class="tab-button flex-1 py-4 px-6 font-semibold text-slate-600 hover:bg-slate-50" data-tab="income">üí∞ Income</button>
        <button class="tab-button flex-1 py-4 px-6 font-semibold text-slate-600 hover:bg-slate-50" data-tab="settlement">üìã Settlement</button>
        <button class="tab-button flex-1 py-4 px-6 font-semibold text-slate-600 hover:bg-slate-50 rounded-tr-2xl" data-tab="history">üóÇÔ∏è History</button>
      </div>

      <div id="expenses-tab" class="tab-content p-6">
        <form id="expenseForm" class="space-y-4 mb-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Date</label>
              <input type="date" id="expenseDate" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500" />
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Category</label>
              <select id="expenseCategory" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500">
                <option value="">Select Category</option>
                <option>Food Expenses</option>
                <option>Office Stationery</option>
                <option>Refunds</option>
                <option>Material Purchases</option>
                <option>Advance Payments</option>
                <option>Fuel Expenses</option>
                <option>Vehicle Maintenance</option>
                <option>Loading/Unloading Labour Charges</option>
                <option>Utility Bills</option>
                <option>Miscellaneous</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Amount (‚Çπ)</label>
              <input type="number" id="expenseAmount" placeholder="0.00" step="0.01" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500" />
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Payment Type</label>
              <select id="expensePayment" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500">
                <option value="">Select</option>
                <option>UPI</option>
                <option>Cash</option>
                <option>Bank Transfer</option>
                <option>Card</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Description</label>
            <input type="text" id="expenseDescription" placeholder="Ex: Diesel for OD 05 BS 8855, lunch for workers..." class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500" />
          </div>
          <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-xl transition duration-200">Add Expense & Notify</button>
          <p class="text-xs text-slate-500 mt-1">WhatsApp includes opening, expenses, receiving, net, and description.</p>
        </form>
        <div id="expensesList" class="space-y-3"></div>
      </div>

      <div id="income-tab" class="tab-content p-6 hidden">
        <form id="incomeForm" class="space-y-4 mb-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Date</label>
              <input type="date" id="incomeDate" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500" />
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Category</label>
              <select id="incomeCategory" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500">
                <option value="">Select Category</option>
                <option>Packers & Movers</option>
                <option>Courier Services</option>
                <option>Railway Ticket Booking</option>
                <option>Flight Ticket Booking</option>
                <option>Jan Seva Kendra</option>
                <option>Passport Services</option>
                <option>PAN Card Services</option>
                <option>Other Services</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Amount (‚Çπ)</label>
              <input type="number" id="incomeAmount" placeholder="0.00" step="0.01" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500" />
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Payment Type</label>
              <select id="incomePayment" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500">
                <option value="">Select</option>
                <option>UPI</option>
                <option>Cash</option>
                <option>Bank Transfer</option>
                <option>Card</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Description</label>
            <input type="text" id="incomeDescription" placeholder="Ex: Advance from Sunny (Paradeep‚ÜíNavi Mumbai)" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500" />
          </div>
          <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl transition duration-200">Add Income & Notify</button>
          <p class="text-xs text-slate-500 mt-1">WhatsApp includes opening, expenses, receiving, net, and description.</p>
        </form>
        <div id="incomesList" class="space-y-3"></div>
      </div>

      <div id="settlement-tab" class="tab-content p-6 hidden">
        <div class="space-y-6">
          <div class="bg-slate-50 rounded-xl p-6">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Opening Balance (Manual)</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Opening Balance (‚Çπ)</label>
                <input type="number" id="openingBalanceInput" step="0.01" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="0.00" />
              </div>
              <button id="btnSaveOpening" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-xl transition duration-200">Save Opening Balance</button>
              <button id="btnUseLastClosing" class="bg-slate-700 hover:bg-slate-800 text-white font-semibold py-3 px-6 rounded-xl transition duration-200">Use Last Day Closing</button>
            </div>
          </div>

          <div class="bg-slate-50 rounded-xl p-6">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Daily Summary</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
              <div class="text-center">
                <p class="text-sm text-slate-600">Opening</p>
                <p class="text-2xl font-bold text-indigo-600" id="summaryOpening">‚Çπ0</p>
              </div>
              <div class="text-center">
                <p class="text-sm text-slate-600">Expenses</p>
                <p class="text-2xl font-bold text-red-600" id="summaryExpenses">‚Çπ0</p>
              </div>
              <div class="text-center">
                <p class="text-sm text-slate-600">Receiving</p>
                <p class="text-2xl font-bold text-green-600" id="summaryIncome">‚Çπ0</p>
              </div>
              <div class="text-center">
                <p class="text-sm text-slate-600">Net (Closing)</p>
                <p class="text-2xl font-bold text-blue-600" id="summaryBalance">‚Çπ0</p>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <button id="btnExportPDF" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-xl transition duration-200">üìÑ Export PDF</button>
              <button id="btnExportExcel" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl transition duration-200">üìä Export Excel</button>
              <button id="btnShareWA" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-xl transition duration-200">üì± Share WhatsApp (Totals)</button>
              <button onclick="window.print()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl transition duration-200">üñ® Print</button>
            </div>
          </div>

          <button id="btnSettle" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-xl transition duration-200 text-lg">üîí Settle Day (Manual)</button>
        </div>
      </div>

      <div id="history-tab" class="tab-content p-6 hidden">
        <div id="historyList" class="space-y-4"></div>
      </div>
    </div>
  </div>

  <script>
    const WHATSAPP_NUMBER = "919338888550";
    let expenses = JSON.parse(localStorage.getItem('dailyExpenses') || '[]');
    let income = JSON.parse(localStorage.getItem('dailyIncome') || '[]');

    const todayISO = () => new Date().toISOString().split('T')[0];
    const fmtINR = (n) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(n);
    const openWA = (text) => window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(text)}`, '_blank');

    function getOpeningBalance(dateStr) { return parseFloat(localStorage.getItem('opening_' + dateStr) || '0') || 0; }
    function setOpeningBalance(dateStr, amount) { localStorage.setItem('opening_' + dateStr, String(amount || 0)); }

    function setCurrentDate() {
      const today = todayISO();
      document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      document.getElementById('expenseDate').value = today;
      document.getElementById('incomeDate').value = today;
      const ob = getOpeningBalance(today);
      document.getElementById('openingBalanceInput').value = ob.toFixed(2);
      document.getElementById('openingBalanceText').textContent = fmtINR(ob);
    }

    function initTabs() {
      const tabButtons = document.querySelectorAll('.tab-button');
      const tabContents = document.querySelectorAll('.tab-content');
      tabButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const tabName = button.getAttribute('data-tab');
          tabButtons.forEach((btn) => { btn.classList.remove('tab-active'); btn.classList.add('text-slate-600', 'hover:bg-slate-50'); });
          button.classList.add('tab-active'); button.classList.remove('text-slate-600', 'hover:bg-slate-50');
          tabContents.forEach((c) => c.classList.add('hidden'));
          document.getElementById(tabName + '-tab').classList.remove('hidden');
          if (tabName === 'history') renderHistory();
          if (tabName === 'settlement') updateTotals();
        });
      });
    }

    document.getElementById('expenseForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const amount = parseFloat(document.getElementById('expenseAmount').value);
      const item = {
        id: Date.now(),
        date: document.getElementById('expenseDate').value || todayISO(),
        category: document.getElementById('expenseCategory').value.trim(),
        payment: document.getElementById('expensePayment').value.trim(),
        description: document.getElementById('expenseDescription').value.trim(),
        amount: isNaN(amount) ? 0 : amount,
      };
      if (!item.category || !item.payment || !item.amount) return alert('Category, Amount and Payment Type are required.');

      expenses.push(item);
      localStorage.setItem('dailyExpenses', JSON.stringify(expenses));
      renderExpenses(); updateTotals();

      const today = todayISO();
      const ob = getOpeningBalance(today);
      const totalE = expenses.reduce((s, x) => s + x.amount, 0);
      const totalI = income.reduce((s, x) => s + x.amount, 0);
      const net = ob + totalI - totalE;
      const msg = `EXPENSE ENTRY
Date: ${new Date(item.date).toLocaleDateString('en-IN')}
Category: ${item.category}
Amount: ${fmtINR(item.amount)}
Mode: ${item.payment}
Description: ${item.description || '-'}

*Totals Now*
Opening: ${fmtINR(ob)}
Expenses: ${fmtINR(totalE)}
Receiving: ${fmtINR(totalI)}
*Net (Closing): ${fmtINR(net)}*`;
      openWA(msg);

      this.reset(); document.getElementById('expenseDate').value = todayISO();
    });

    document.getElementById('incomeForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const amount = parseFloat(document.getElementById('incomeAmount').value);
      const item = {
        id: Date.now(),
        date: document.getElementById('incomeDate').value || todayISO(),
        category: document.getElementById('incomeCategory').value.trim(),
        payment: document.getElementById('incomePayment').value.trim(),
        description: document.getElementById('incomeDescription').value.trim(),
        amount: isNaN(amount) ? 0 : amount,
      };
      if (!item.category || !item.payment || !item.amount) return alert('Category, Amount and Payment Type are required.');

      income.push(item);
      localStorage.setItem('dailyIncome', JSON.stringify(income));
      renderIncome(); updateTotals();

      const today = todayISO();
      const ob = getOpeningBalance(today);
      const totalE = expenses.reduce((s, x) => s + x.amount, 0);
      const totalI = income.reduce((s, x) => s + x.amount, 0);
      const net = ob + totalI - totalE;
      const msg = `RECEIVING ENTRY
Date: ${new Date(item.date).toLocaleDateString('en-IN')}
Category: ${item.category}
Amount: ${fmtINR(item.amount)}
Mode: ${item.payment}
Description: ${item.description || '-'}

*Totals Now*
Opening: ${fmtINR(ob)}
Expenses: ${fmtINR(totalE)}
Receiving: ${fmtINR(totalI)}
*Net (Closing): ${fmtINR(net)}*`;
      openWA(msg);

      this.reset(); document.getElementById('incomeDate').value = todayISO();
    });

    function renderExpenses() {
      const container = document.getElementById('expensesList');
      container.innerHTML = '';
      expenses.forEach((e) => {
        const div = document.createElement('div');
        div.className = 'expense-card bg-white rounded-xl shadow-md p-4';
        div.innerHTML = `
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <div class="flex flex-wrap gap-2 mb-2">
                <span class="bg-red-100 text-red-800 text-xs font-medium px-2 py-1 rounded-full">${e.category}</span>
                <span class="text-xs text-slate-500">${new Date(e.date).toLocaleDateString('en-IN')}</span>
                <span class="bg-slate-100 text-slate-700 text-xs font-medium px-2 py-1 rounded-full">${e.payment || ''}</span>
              </div>
              <p class="font-medium text-slate-800">${e.description || ''}</p>
              <p class="text-lg font-bold text-red-600">${fmtINR(e.amount)}</p>
            </div>
            <button onclick="deleteExpense(${e.id})" class="text-red-500 hover:text-red-700 ml-4" title="Delete">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>`;
        container.appendChild(div);
      });
    }

    function renderIncome() {
      const container = document.getElementById('incomesList');
      container.innerHTML = '';
      income.forEach((i) => {
        const div = document.createElement('div');
        div.className = 'income-card bg-white rounded-xl shadow-md p-4';
        div.innerHTML = `
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <div class="flex flex-wrap gap-2 mb-2">
                <span class="bg-green-100 text-green-800 text-xs font-medium px-2 py-1 rounded-full">${i.category}</span>
                <span class="text-xs text-slate-500">${new Date(i.date).toLocaleDateString('en-IN')}</span>
                <span class="bg-slate-100 text-slate-700 text-xs font-medium px-2 py-1 rounded-full">${i.payment || ''}</span>
              </div>
              <p class="font-medium text-slate-800">${i.description || ''}</p>
              <p class="text-lg font-bold text-green-600">${fmtINR(i.amount)}</p>
            </div>
            <button onclick="deleteIncome(${i.id})" class="text-red-500 hover:text-red-700 ml-4" title="Delete">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>`;
        container.appendChild(div);
      });
    }

    function updateTotals() {
      const today = todayISO();
      const ob = getOpeningBalance(today);
      const totalE = expenses.reduce((s, x) => s + x.amount, 0);
      const totalI = income.reduce((s, x) => s + x.amount, 0);
      const net = ob + totalI - totalE;
      document.getElementById('openingBalanceText').textContent = fmtINR(ob);
      document.getElementById('totalExpenses').textContent = fmtINR(totalE);
      document.getElementById('totalIncome').textContent = fmtINR(totalI);
      document.getElementById('netBalance').textContent = fmtINR(net);
      document.getElementById('summaryOpening').textContent = fmtINR(ob);
      document.getElementById('summaryExpenses').textContent = fmtINR(totalE);
      document.getElementById('summaryIncome').textContent = fmtINR(totalI);
      document.getElementById('summaryBalance').textContent = fmtINR(net);
    }

    function buildPDFDoc() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });
      const margin = 40;
      const width = doc.internal.pageSize.getWidth() - margin * 2;
      const lineHeight = 16;

      const today = todayISO();
      const ob = getOpeningBalance(today);
      const totalE = expenses.reduce((s, x) => s + x.amount, 0);
      const totalI = income.reduce((s, x) => s + x.amount, 0);
      const net = ob + totalI - totalE;

      doc.setFontSize(18);
      doc.text("A to Z Packers & Movers", margin, margin);
      doc.setFontSize(14);
      doc.text("Daily Accounts Report", margin, margin + 22);
      doc.setFontSize(11);
      doc.text(`Date: ${new Date().toLocaleDateString('en-IN')}`, margin, margin + 40);

      let y = margin + 70;
      function addSection(title) { doc.setFontSize(13); doc.text(title, margin, y); y += 10; doc.setDrawColor(60); doc.line(margin, y, margin + width, y); y += 14; }
      function addRow(left, right) {
        const text = `${left}  ‚Äî  ${right}`;
        const lines = doc.splitTextToSize(text, width);
        lines.forEach((ln) => { if (y > doc.internal.pageSize.getHeight() - margin) { doc.addPage(); y = margin; } doc.text(ln, margin, y); y += lineHeight; });
      }

      addSection("OPENING"); addRow("Opening Balance", fmtINR(ob));
      y += 10; addSection("EXPENSES"); if (expenses.length === 0) { addRow("No expenses", ""); }
      expenses.forEach((e) => addRow(`${e.category} | ${new Date(e.date).toLocaleDateString('en-IN')} | ${e.payment} | ${e.description}`, fmtINR(e.amount)));
      addRow("Total Expenses", fmtINR(totalE));
      y += 10; addSection("INCOME"); if (income.length === 0) { addRow("No income", ""); }
      income.forEach((i) => addRow(`${i.category} | ${new Date(i.date).toLocaleDateString('en-IN')} | ${i.payment} | ${i.description}`, fmtINR(i.amount)));
      addRow("Total Income", fmtINR(totalI));
      y += 10; addSection("CLOSING"); addRow("Net (Closing)", fmtINR(net));

      return doc;
    }

    async function exportToPDF() { const doc = buildPDFDoc(); const today = new Date().toLocaleDateString('en-IN').replace(/\//g, '-'); doc.save(`Daily_Report_${today}.pdf`); }
    function exportToExcel() {
      const wb = XLSX.utils.book_new();
      const today = todayISO();
      const ob = getOpeningBalance(today);
      const expWS = XLSX.utils.json_to_sheet(expenses.map(e => ({ Date: e.date, Category: e.category, Payment: e.payment, Description: e.description, Amount: e.amount })));
      const incWS = XLSX.utils.json_to_sheet(income.map(i => ({ Date: i.date, Category: i.category, Payment: i.payment, Description: i.description, Amount: i.amount })));
      const sumWS = XLSX.utils.json_to_sheet([{ Opening: ob, Expenses: expenses.reduce((s,x)=>s+x.amount,0), Receiving: income.reduce((s,x)=>s+x.amount,0), Net: ob + income.reduce((s,x)=>s+x.amount,0) - expenses.reduce((s,x)=>s+x.amount,0) }]);
      XLSX.utils.book_append_sheet(wb, sumWS, 'Summary'); XLSX.utils.book_append_sheet(wb, expWS, 'Expenses'); XLSX.utils.book_append_sheet(wb, incWS, 'Income');
      const name = new Date().toLocaleDateString('en-IN').replace(/\//g, '-'); XLSX.writeFile(wb, `Daily_Accounts_${name}.xlsx`);
    }
    async function shareTotalsToWhatsApp() {
      const today = todayISO(); const ob = getOpeningBalance(today);
      const totalE = expenses.reduce((s, x) => s + x.amount, 0); const totalI = income.reduce((s, x) => s + x.amount, 0);
      const net = ob + totalI - totalE; const msg = `*Daily Totals - ${new Date().toLocaleDateString('en-IN')}*\nOpening: ${fmtINR(ob)}\nExpenses: ${fmtINR(totalE)}\nReceiving: ${fmtINR(totalI)}\n*Net (Closing): ${fmtINR(net)}*`; openWA(msg);
    }

    function settleDay() {
      if (!confirm("Settle today's accounts now? You can do this anytime.")) return;
      const today = todayISO(); const ob = getOpeningBalance(today);
      const settlementData = { date: today, opening: ob, expenses: [...expenses], income: [...income], settled: true, timestamp: Date.now() };
      localStorage.setItem(`settlement_${today}`, JSON.stringify(settlementData));
      alert('Day settled successfully! Entries are saved to history.');
      expenses = []; income = [];
      localStorage.setItem('dailyExpenses', JSON.stringify(expenses)); localStorage.setItem('dailyIncome', JSON.stringify(income));
      renderExpenses(); renderIncome(); updateTotals(); renderHistory();
    }

    function getHistoryKeys() { return Object.keys(localStorage).filter(k => k.startsWith('settlement_')).sort(); }
    function renderHistory() {
      const container = document.getElementById('historyList'); container.innerHTML = '';
      const keys = getHistoryKeys(); if (keys.length === 0) { container.innerHTML = '<p class="text-slate-600">No settlement history yet.</p>'; return; }
      keys.forEach((k) => {
        const rec = JSON.parse(localStorage.getItem(k) || '{}');
        const opening = parseFloat(rec.opening || 0);
        const totalE = (rec.expenses || []).reduce((s, x) => s + (x.amount || 0), 0);
        const totalI = (rec.income || []).reduce((s, x) => s + (x.amount || 0), 0);
        const net = opening + totalI - totalE;
        const card = document.createElement('div'); card.className = 'bg-white rounded-xl shadow p-4 border border-slate-200';
        card.innerHTML = `
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
            <div>
              <p class="text-slate-800 font-semibold">Date: ${new Date(rec.date).toLocaleDateString('en-IN')}</p>
              <p class="text-slate-600 text-sm">Opening: ${fmtINR(opening)} | Expenses: ${fmtINR(totalE)} | Receiving: ${fmtINR(totalI)} | Net (Closing): ${fmtINR(net)}</p>
            </div>
            <div class="flex gap-2">
              <button class="px-3 py-2 rounded-lg bg-red-600 text-white text-sm" onclick="downloadHistoryPDF('${k}')">PDF</button>
              <button class="px-3 py-2 rounded-lg bg-green-600 text-white text-sm" onclick="downloadHistoryExcel('${k}')">Excel</button>
              <button class="px-3 py-2 rounded-lg bg-slate-700 text-white text-sm" onclick="shareHistoryWA('${k}')">WhatsApp (Totals)</button>
              <button class="px-3 py-2 rounded-lg bg-slate-200 text-slate-800 text-sm" onclick="deleteHistory('${k}')">Delete</button>
            </div>
          </div>`; container.appendChild(card);
      });
    }
    function downloadHistoryPDF(key) {
      const rec = JSON.parse(localStorage.getItem(key) || '{}');
      const backupExp = expenses, backupInc = income;
      const today = todayISO(); const originalOB = getOpeningBalance(today);
      setOpeningBalance(today, parseFloat(rec.opening || 0)); expenses = rec.expenses || []; income = rec.income || [];
      const doc = buildPDFDoc(); const name = key.replace('settlement_', ''); doc.save(`Daily_Report_${name}.pdf`);
      setOpeningBalance(today, originalOB); expenses = backupExp; income = backupInc; updateTotals();
    }
    function downloadHistoryExcel(key) {
      const rec = JSON.parse(localStorage.getItem(key) || '{}');
      const wb = XLSX.utils.book_new();
      const opening = parseFloat(rec.opening || 0);
      const expWS = XLSX.utils.json_to_sheet((rec.expenses || []).map(e => ({ Date: e.date, Category: e.category, Payment: e.payment, Description: e.description, Amount: e.amount })));
      const incWS = XLSX.utils.json_to_sheet((rec.income || []).map(i => ({ Date: i.date, Category: i.category, Payment: i.payment, Description: i.description, Amount: i.amount })));
      const sumWS = XLSX.utils.json_to_sheet([{ Opening: opening, Expenses: (rec.expenses||[]).reduce((s,x)=>s+(x.amount||0),0), Receiving: (rec.income||[]).reduce((s,x)=>s+(x.amount||0),0), Net: opening + (rec.income||[]).reduce((s,x)=>s+(x.amount||0),0) - (rec.expenses||[]).reduce((s,x)=>s+(x.amount||0),0) }]);
      XLSX.utils.book_append_sheet(wb, sumWS, 'Summary'); XLSX.utils.book_append_sheet(wb, expWS, 'Expenses'); XLSX.utils.book_append_sheet(wb, incWS, 'Income');
      const name = key.replace('settlement_', ''); XLSX.writeFile(wb, `Daily_Accounts_${name}.xlsx`);
    }
    function shareHistoryWA(key) {
      const rec = JSON.parse(localStorage.getItem(key) || '{}');
      const opening = parseFloat(rec.opening || 0);
      const totalE = (rec.expenses || []).reduce((s, x) => s + (x.amount || 0), 0);
      const totalI = (rec.income || []).reduce((s, x) => s + (x.amount || 0), 0);
      const net = opening + totalI - totalE;
      const dateStr = new Date(rec.date).toLocaleDateString('en-IN');
      const msg = `*Daily Totals - ${dateStr}*\nOpening: ${fmtINR(opening)}\nExpenses: ${fmtINR(totalE)}\nReceiving: ${fmtINR(totalI)}\n*Net (Closing): ${fmtINR(net)}*`; openWA(msg);
    }

    document.getElementById('btnSaveOpening').addEventListener('click', () => {
      const amt = parseFloat(document.getElementById('openingBalanceInput').value || '0') || 0;
      setOpeningBalance(todayISO(), amt);
      document.getElementById('openingBalanceText').textContent = fmtINR(amt);
      updateTotals(); alert('Opening balance saved.');
    });
    document.getElementById('btnUseLastClosing').addEventListener('click', () => {
      const today = todayISO();
      const keys = Object.keys(localStorage).filter(k => k.startsWith('settlement_')).map(k => k.replace('settlement_', '')).sort();
      const idx = keys.findIndex(k => k >= today); const lastDate = idx <= 0 ? keys[keys.length - 1] : keys[idx - 1];
      if (!lastDate) return alert('No previous settlement found.');
      const rec = JSON.parse(localStorage.getItem('settlement_' + lastDate) || '{}');
      const totalE = (rec.expenses || []).reduce((s, x) => s + (x.amount || 0), 0);
      const totalI = (rec.income || []).reduce((s, x) => s + (x.amount || 0), 0);
      const opening = parseFloat(rec.opening || 0); const closing = opening + totalI - totalE;
      setOpeningBalance(today, closing);
      document.getElementById('openingBalanceInput').value = closing.toFixed(2);
      document.getElementById('openingBalanceText').textContent = fmtINR(closing);
      updateTotals(); alert(`Opening set from last closing (${new Date(lastDate).toLocaleDateString('en-IN')}).`);
    });

    document.getElementById('btnExportPDF').addEventListener('click', exportToPDF);
    document.getElementById('btnExportExcel').addEventListener('click', exportToExcel);
    document.getElementById('btnShareWA').addEventListener('click', shareTotalsToWhatsApp);
    document.getElementById('btnSettle').addEventListener('click', settleDay);

    function init() { setCurrentDate(); initTabs(); renderExpenses(); renderIncome(); updateTotals(); }
    init();
  </script>
</body>
</html>
