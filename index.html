<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <!-- Mobile-friendly + prevent sideways panning -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>A to Z ‚Äì Daily Accounts (Realtime)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --primary-1:#22c55e;  /* green theme */
      --primary-2:#15803d;
      --accent-red:#dc2626; /* expenses red */
      --ok-green:#16a34a;  /* income green */
    }
    html,body{max-width:100%;overflow-x:hidden}
    .card{background:#fff;border-radius:1rem;box-shadow:0 6px 18px rgba(2,6,23,.08)}
    .tab-active{background:linear-gradient(135deg,var(--primary-1),var(--primary-2));color:#fff}
    .btn{border-radius:.9rem;padding:.65rem 1rem;font-weight:600;white-space:nowrap}
    .btn-primary{background:var(--primary-1);color:#fff}
    .btn-primary:hover{background:var(--primary-2)}
    .btn-danger{background:var(--accent-red);color:#fff}
    .text-expense{color:var(--accent-red)}
    .text-income{color:var(--ok-green)}
    .hidden{display:none}
  </style>
</head>
<body class="bg-slate-100 min-h-screen">
  <!-- Header -->
  <header class="card max-w-full sm:max-w-5xl mx-auto mt-3 px-4 py-3">
    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
      <div>
        <h1 class="text-xl sm:text-2xl font-bold text-slate-900">A to Z Packers & Movers</h1>
        <p class="text-slate-600 text-sm">Daily Accounts (Firestore, realtime)</p>
      </div>
      <div class="text-left sm:text-right">
        <p id="todayText" class="text-slate-600 text-sm"></p>
        <div class="mt-2 flex items-center gap-2 sm:justify-end">
          <span id="whoami" class="text-xs sm:text-sm text-slate-600"></span>
          <button id="btnSignOutTop" class="btn btn-danger hidden text-xs sm:text-sm">Sign out</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Auth -->
  <section id="authCard" class="card max-w-full sm:max-w-5xl mx-auto mt-3 p-4">
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
      <input id="email" type="email" placeholder="you@example.com" class="px-3 py-2 border rounded-xl w-full"/>
      <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="px-3 py-2 border rounded-xl w-full"/>
      <button id="btnSignIn" class="btn btn-primary w-full">Sign in</button>
    </div>
    <p id="authMsg" class="mt-2 text-sm text-rose-600"></p>
  </section>

  <!-- Error banner -->
  <div id="errBar" class="hidden max-w-full sm:max-w-5xl mx-auto mt-3 bg-rose-50 text-rose-700 border border-rose-200 rounded-xl px-4 py-2 text-sm">
    <span id="errText"></span>
  </div>

  <!-- App -->
  <section id="app" class="hidden max-w-full sm:max-w-5xl mx-auto mt-3 card">
    <div class="flex text-sm flex-wrap">
      <button class="tab flex-1 py-3 px-2 tab-active" data-tab="expenses">üìä Expenses</button>
      <button class="tab flex-1 py-3 px-2" data-tab="income">üí∞ Income</button>
      <button class="tab flex-1 py-3 px-2" data-tab="settlement">ü§ù Settlement</button>
      <button class="tab flex-1 py-3 px-2" data-tab="history">üìú History</button>
    </div>

    <!-- Expenses -->
    <div id="expenses" class="p-4">
      <form id="expenseForm" class="grid grid-cols-1 gap-2 mb-3">
        <input type="date" id="expenseDate" class="px-3 py-2 border rounded-xl w-full"/>
        <select id="expenseCategory" class="px-3 py-2 border rounded-xl w-full"></select>
        <select id="expensePayment" class="px-3 py-2 border rounded-xl w-full">
          <option value="">Mode</option><option>UPI</option><option>Cash</option><option>Bank Transfer</option><option>Card</option>
        </select>
        <input type="number" id="expenseAmount" placeholder="Amount ‚Çπ" step="0.01" class="px-3 py-2 border rounded-xl w-full"/>
        <input type="text" id="expenseDescription" placeholder="Description" class="px-3 py-2 border rounded-xl w-full"/>
        <!-- ONLY one button: Add & Notify -->
        <button class="btn btn-danger w-full">Add Expense & Notify</button>
      </form>
      <div id="expensesList" class="space-y-2"></div>
    </div>

    <!-- Income -->
    <div id="income" class="p-4 hidden">
      <form id="incomeForm" class="grid grid-cols-1 gap-2 mb-3">
        <input type="date" id="incomeDate" class="px-3 py-2 border rounded-xl w-full"/>
        <select id="incomeCategory" class="px-3 py-2 border rounded-xl w-full"></select>
        <select id="incomePayment" class="px-3 py-2 border rounded-xl w-full">
          <option value="">Mode</option><option>UPI</option><option>Cash</option><option>Bank Transfer</option><option>Card</option>
        </select>
        <input type="number" id="incomeAmount" placeholder="Amount ‚Çπ" step="0.01" class="px-3 py-2 border rounded-xl w-full"/>
        <input type="text" id="incomeDescription" placeholder="Description" class="px-3 py-2 border rounded-xl w-full"/>
        <!-- ONLY one button: Add & Notify -->
        <button class="btn btn-primary w-full">Add Income & Notify</button>
      </form>
      <div id="incomesList" class="space-y-2"></div>
    </div>

    <!-- Settlement -->
    <div id="settlement" class="p-4 hidden">
      <form id="settlementForm" class="grid grid-cols-1 gap-2 mb-3">
        <input type="date" id="settlementDate" class="px-3 py-2 border rounded-xl w-full"/>
        <select id="settlementType" class="px-3 py-2 border rounded-xl w-full">
          <option value="">Type</option><option>Given</option><option>Received</option><option>Opening</option>
        </select>
        <!-- Include both category pickers as requested -->
        <select id="settleExpenseCategory" class="px-3 py-2 border rounded-xl w-full"></select>
        <select id="settleIncomeCategory" class="px-3 py-2 border rounded-xl w-full"></select>
        <input type="number" id="settlementAmount" placeholder="Amount ‚Çπ" step="0.01" class="px-3 py-2 border rounded-xl w-full"/>
        <input type="text" id="settlementDescription" placeholder="Description" class="px-3 py-2 border rounded-xl w-full"/>
        <!-- Settlement stays WITHOUT notify -->
        <button class="btn btn-primary w-full">Add Settlement</button>
      </form>
      <div id="settlementList" class="space-y-2"></div>
    </div>

    <!-- History -->
    <div id="history" class="p-4 hidden">
      <div class="flex flex-col sm:flex-row gap-2 items-center mb-3">
        <input type="date" id="histFrom" class="px-3 py-2 border rounded-xl w-full sm:w-auto"/>
        <input type="date" id="histTo"   class="px-3 py-2 border rounded-xl w-full sm:w-auto"/>
        <button id="btnLoadHistory" class="btn btn-primary w-full sm:w-auto">Load</button>
      </div>
      <div id="historyList" class="space-y-3"></div>
    </div>
  </section>

  <script type="module">
    /* ---------- Firebase ---------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, query, where, getDocs, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCieI_dFRI3K-TDNy0JFe02ndbT2ZO4bag",
      authDomain: "a-to-z-daily-account.firebaseapp.com",
      projectId: "a-to-z-daily-account",
      storageBucket: "a-to-z-daily-account.firebasestorage.app",
      messagingSenderId: "248686153632",
      appId: "1:248686153632:web:4399b9f34b0c97ae46dec5"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* ---------- Utils ---------- */
    const $ = (id)=>document.getElementById(id);
    const fmtINR = (n)=>new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR'}).format(+n||0);
    function todayIST(){
      const now = new Date();
      const utc = now.getTime() + now.getTimezoneOffset()*60000;
      const ist = new Date(utc + 5.5*3600000);
      const y=ist.getFullYear(), m=String(ist.getMonth()+1).padStart(2,"0"), d=String(ist.getDate()).padStart(2,"0");
      return `${y}-${m}-${d}`;
    }
    function showError(e){ $("errText").textContent = e?.message || e; $("errBar").classList.remove("hidden"); setTimeout(()=>$("errBar").classList.add("hidden"), 5000); }
    function wa(text){ window.open(`https://wa.me/919338888550?text=${encodeURIComponent(text)}`,"_blank"); }

    $("todayText").textContent = new Date().toLocaleString('en-IN',{timeZone:'Asia/Kolkata',weekday:'long',day:'2-digit',month:'long',year:'numeric'});

    // Default dates
    ["expenseDate","incomeDate","settlementDate","histFrom","histTo"].forEach(id=>$(id).value = todayIST());

    // Categories (with Tools added in Expenses)
    const expenseCategories = ["Food Expenses","Fuel Expenses","Material Purchases","Tools / Equipment","Miscellaneous","Repair","Stationery","Labour"];
    const incomeCategories  = ["Packers & Movers","Courier Services","Railway Ticket","Flight Ticket","PAN Services","Other Services"];
    const fill = (el, list, label)=>{ el.innerHTML = `<option value="">${label}</option>` + list.map(x=>`<option>${x}</option>`).join(""); };
    fill($("expenseCategory"), expenseCategories, "Category");
    fill($("incomeCategory"),  incomeCategories,  "Category");
    fill($("settleExpenseCategory"), expenseCategories, "Expense Category (optional)");
    fill($("settleIncomeCategory"),  incomeCategories,  "Income Category (optional)");

    /* ---------- Tabs ---------- */
    document.querySelectorAll(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".tab").forEach(b=>b.classList.remove("tab-active"));
        btn.classList.add("tab-active");
        ["expenses","income","settlement","history"].forEach(id=>$(id).classList.add("hidden"));
        $(btn.dataset.tab).classList.remove("hidden");
      });
    });

    /* ---------- Auth ---------- */
    $("btnSignIn").addEventListener("click", async ()=>{
      $("authMsg").textContent="";
      try{
        await signInWithEmailAndPassword(auth, $("email").value.trim(), $("password").value);
      }catch(e){ $("authMsg").textContent = e?.message || "Sign-in failed"; }
    });
    $("btnSignOutTop").addEventListener("click", ()=>signOut(auth).catch(showError));

    onAuthStateChanged(auth, (user)=>{
      if(user){
        $("whoami").textContent = user.email;
        $("authCard").classList.add("hidden");
        $("app").classList.remove("hidden");
        $("btnSignOutTop").classList.remove("hidden");
        startRealtime(todayIST());
      }else{
        $("authCard").classList.remove("hidden");
        $("app").classList.add("hidden");
        $("btnSignOutTop").classList.add("hidden");
      }
    });

    /* ---------- Realtime (for selected/today date) ---------- */
    let unE=null, unI=null, unS=null;
    function startRealtime(dateStr){
      if(unE)unE(); if(unI)unI(); if(unS)unS();
      unE = onSnapshot(query(collection(db,"expenses"), where("date","==",dateStr)), (snap)=>{
        renderList($("expensesList"), snap.docs.map(d=>({id:d.id, ...d.data()})), "expense");
      }, showError);
      unI = onSnapshot(query(collection(db,"income"), where("date","==",dateStr)), (snap)=>{
        renderList($("incomesList"), snap.docs.map(d=>({id:d.id, ...d.data()})), "income");
      }, showError);
      unS = onSnapshot(query(collection(db,"settlement"), where("date","==",dateStr)), (snap)=>{
        renderList($("settlementList"), snap.docs.map(d=>({id:d.id, ...d.data()})), "settlement");
      }, showError);
    }

    function renderList(container, arr, type){
      container.innerHTML = "";
      arr.sort((a,b)=>(a.updatedAt?.seconds||0)-(b.updatedAt?.seconds||0));
      arr.forEach(it=>{
        // settlement signed amount for visual cue
        let amount = Number(it.amount||0);
        let color  = (type==="expense") ? "text-expense" : "text-income";
        let mode   = it.payment || "-";
        let label  = it.category || "-";
        if(type==="settlement"){
          mode = it.type || "-";
          label = it.expCategory || it.incCategory || it.type || "-";
          if(it.type==="Given"){ amount = -amount; color = "text-expense"; }
          else { color = "text-income"; }
        }
        const row = document.createElement("div");
        row.className = "border rounded-xl px-3 py-2";
        row.innerHTML = `
          <div class="flex justify-between items-center gap-3">
            <div class="text-sm">
              <div class="font-semibold">${label}</div>
              <div class="text-slate-500">${new Date(it.date).toLocaleDateString('en-IN')} ‚Ä¢ ${mode}</div>
              <div class="text-slate-700 break-words">${it.description||""}</div>
            </div>
            <div class="text-right ${color} font-bold">${fmtINR(amount)}</div>
          </div>`;
        container.appendChild(row);
      });
    }

    /* ---------- WhatsApp message builders ---------- */
    function entryMsg(kind, item){
      return [
        `*${kind.toUpperCase()} ENTRY*`,
        `üìÖ *Date:* ${item.date}`,
        `üìÇ *Category:* ${item.category}`,
        `üíµ *Amount:* ${fmtINR(item.amount)}`,
        `üí≥ *Mode:* ${item.payment}`,
        `üìù *Note:* ${item.description || '-'}`,
      ].join('\n');
    }
    function summaryMsg(forDate, eTot, iTot, sRows){
      const seTotal = sRows.reduce((t,x)=>t + (x.type==="Given"?-1:1)*Number(x.amount||0),0);
      const opening = sRows.filter(x=>x.type==="Opening").reduce((t,x)=>t+Number(x.amount||0),0);
      return [
        `*DAILY SUMMARY*`,
        `Date: ${forDate.split("-").reverse().join("/")}`,
        `--------------------------------`,
        `*Income:* ${fmtINR(iTot)}`,
        `*Expenses:* ${fmtINR(eTot)}`,
        `*Settlements:* ${fmtINR(seTotal)} (Received +, Given -)`,
        `*Opening:* ${fmtINR(opening)}`,
        `--------------------------------`,
        `*Net (Closing):* ${fmtINR(iTot - eTot + seTotal + opening)}`
      ].join('\n');
    }

    /* ---------- Add & Notify (single button) ---------- */
    $("expenseForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const item = {
        date:$("expenseDate").value || todayIST(),
        category:$("expenseCategory").value,
        payment:$("expensePayment").value,
        description:$("expenseDescription").value,
        amount:+$("expenseAmount").value,
        updatedAt:serverTimestamp(),
        updatedBy:auth.currentUser?.email
      };
      if(!item.category || !item.payment || !item.amount) return showError("Expense: Category, Mode, Amount are required.");
      await addDoc(collection(db,"expenses"), item);
      wa(entryMsg("Expense", item)); // notify
      $("expenseAmount").value=""; $("expenseDescription").value="";
    });

    $("incomeForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const item = {
        date:$("incomeDate").value || todayIST(),
        category:$("incomeCategory").value,
        payment:$("incomePayment").value,
        description:$("incomeDescription").value,
        amount:+$("incomeAmount").value,
        updatedAt:serverTimestamp(),
        updatedBy:auth.currentUser?.email
      };
      if(!item.category || !item.payment || !item.amount) return showError("Income: Category, Mode, Amount are required.");
      await addDoc(collection(db,"income"), item);
      wa(entryMsg("Income", item)); // notify
      $("incomeAmount").value=""; $("incomeDescription").value="";
    });

    $("settlementForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const item = {
        date:$("settlementDate").value || todayIST(),
        type:$("settlementType").value,
        expCategory:$("settleExpenseCategory").value || null,
        incCategory:$("settleIncomeCategory").value || null,
        description:$("settlementDescription").value,
        amount:+$("settlementAmount").value,
        updatedAt:serverTimestamp(),
        updatedBy:auth.currentUser?.email
      };
      if(!item.type || !item.amount) return showError("Settlement: Type & Amount are required.");
      await addDoc(collection(db,"settlement"), item);
      $("settlementAmount").value=""; $("settlementDescription").value="";
    });

    /* ---------- History loader ---------- */
    $("btnLoadHistory").addEventListener("click", async ()=>{
      const from = $("histFrom").value, to = $("histTo").value;
      const list = $("historyList");
      list.innerHTML = "";
      const d0 = new Date(from), d1 = new Date(to);
      for(let d=new Date(d0); d<=d1; d.setDate(d.getDate()+1)){
        const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), da=String(d.getDate()).padStart(2,"0");
        const key=`${y}-${m}-${da}`;
        const [ex,inc,setl] = await Promise.all([
          getDocs(query(collection(db,"expenses"), where("date","==",key))),
          getDocs(query(collection(db,"income"),   where("date","==",key))),
          getDocs(query(collection(db,"settlement"), where("date","==",key)))
        ]);
        const eTot = ex.docs.reduce((s,x)=>s+Number(x.data().amount||0),0);
        const iTot = inc.docs.reduce((s,x)=>s+Number(x.data().amount||0),0);
        const sRows = setl.docs.map(x=>x.data());

        const card=document.createElement("div");
        card.className="card p-3";
        card.innerHTML=`
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
            <div>
              <div class="font-semibold">Date: ${key.split("-").reverse().join("/")}</div>
              <div class="text-slate-600 text-sm">Expenses: ${fmtINR(eTot)} | Income: ${fmtINR(iTot)}</div>
            </div>
            <div class="flex gap-2">
              <button class="btn btn-primary w-full sm:w-auto" data-wa="${key}">WhatsApp Summary</button>
            </div>
          </div>`;
        card.querySelector("[data-wa]").addEventListener("click", ()=>{
          wa(summaryMsg(key, eTot, iTot, sRows));
        });
        list.appendChild(card);
      }
    });
  </script>
</body>
</html>