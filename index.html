<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <!-- Mobile-friendly + locked zoom to prevent sideways panning -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>A to Z â€“ Daily Accounts (Realtime)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --primary-1:#22c55e;  /* green theme */
      --primary-2:#15803d;
      --accent-red:#dc2626; /* expenses red */
      --ok-green:#16a34a;  /* income green */
    }
    /* Mobile safety */
    html,body{max-width:100%; overflow-x:hidden;}
    .card{background:#fff;border-radius:1rem;box-shadow:0 6px 18px rgba(2,6,23,.08)}
    .tab-active{background:linear-gradient(135deg,var(--primary-1),var(--primary-2));color:#fff}
    .btn{border-radius:.9rem;padding:.65rem 1rem;font-weight:600;white-space:nowrap}
    .btn-primary{background:var(--primary-1);color:#fff}
    .btn-primary:hover{background:var(--primary-2)}
    .btn-danger{background:var(--accent-red);color:#fff}
    .text-expense{color:var(--accent-red)}
    .text-income{color:var(--ok-green)}
    .hidden{display:none}
  </style>
</head>
<body class="bg-slate-100 min-h-screen">
  <!-- Header -->
  <header class="card max-w-full sm:max-w-5xl mx-auto mt-3 px-4 py-3">
    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
      <div>
        <h1 class="text-xl sm:text-2xl font-bold text-slate-900">A to Z Packers & Movers</h1>
        <p class="text-slate-600 text-sm">Daily Accounts (Firestore, realtime)</p>
      </div>
      <div class="text-left sm:text-right">
        <p id="todayText" class="text-slate-600 text-sm"></p>
        <div class="mt-2 flex items-center gap-2 sm:justify-end">
          <span id="whoami" class="text-xs sm:text-sm text-slate-600"></span>
          <button id="btnSignOutTop" class="btn btn-danger hidden text-xs sm:text-sm">Sign out</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Auth (simple email/password) -->
  <section id="authCard" class="card max-w-full sm:max-w-5xl mx-auto mt-3 p-4">
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
      <input id="email" type="email" placeholder="you@example.com" class="px-3 py-2 border rounded-xl w-full"/>
      <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="px-3 py-2 border rounded-xl w-full"/>
      <button id="btnSignIn" class="btn btn-primary w-full">Sign in</button>
    </div>
    <p id="authMsg" class="mt-2 text-sm text-rose-600"></p>
  </section>

  <!-- Error banner -->
  <div id="errBar" class="hidden max-w-full sm:max-w-5xl mx-auto mt-3 bg-rose-50 text-rose-700 border border-rose-200 rounded-xl px-4 py-2 text-sm">
    <span id="errText"></span>
  </div>

  <!-- App -->
  <section id="app" class="hidden max-w-full sm:max-w-5xl mx-auto mt-3 card">
    <div class="flex text-sm flex-wrap">
      <button class="tab flex-1 py-3 px-2 tab-active" data-tab="expenses">ðŸ“Š Expenses</button>
      <button class="tab flex-1 py-3 px-2" data-tab="income">ðŸ’° Income</button>
    </div>

    <!-- Expenses -->
    <div id="expenses" class="p-4">
      <form id="expenseForm" class="grid grid-cols-1 gap-2 mb-3">
        <input type="date" id="expenseDate" class="px-3 py-2 border rounded-xl w-full"/>
        <select id="expenseCategory" class="px-3 py-2 border rounded-xl w-full"></select>
        <select id="expensePayment" class="px-3 py-2 border rounded-xl w-full">
          <option value="">Mode</option><option>UPI</option><option>Cash</option><option>Bank Transfer</option><option>Card</option>
        </select>
        <input type="number" id="expenseAmount" placeholder="Amount â‚¹" step="0.01" class="px-3 py-2 border rounded-xl w-full"/>
        <input type="text" id="expenseDescription" placeholder="Description" class="px-3 py-2 border rounded-xl w-full"/>
        <div class="flex flex-col sm:flex-row gap-2">
          <button class="btn btn-danger flex-1 text-center">Add Expense</button>
          <button type="button" id="btnExpenseNotify" class="btn btn-primary flex-1 text-center">Add & Notify</button>
        </div>
      </form>
      <div id="expensesList" class="space-y-2"></div>
    </div>

    <!-- Income -->
    <div id="income" class="p-4 hidden">
      <form id="incomeForm" class="grid grid-cols-1 gap-2 mb-3">
        <input type="date" id="incomeDate" class="px-3 py-2 border rounded-xl w-full"/>
        <select id="incomeCategory" class="px-3 py-2 border rounded-xl w-full"></select>
        <select id="incomePayment" class="px-3 py-2 border rounded-xl w-full">
          <option value="">Mode</option><option>UPI</option><option>Cash</option><option>Bank Transfer</option><option>Card</option>
        </select>
        <input type="number" id="incomeAmount" placeholder="Amount â‚¹" step="0.01" class="px-3 py-2 border rounded-xl w-full"/>
        <input type="text" id="incomeDescription" placeholder="Description" class="px-3 py-2 border rounded-xl w-full"/>
        <div class="flex flex-col sm:flex-row gap-2">
          <button class="btn btn-primary flex-1 text-center">Add Income</button>
          <button type="button" id="btnIncomeNotify" class="btn btn-primary flex-1 text-center">Add & Notify</button>
        </div>
      </form>
      <div id="incomesList" class="space-y-2"></div>
    </div>
  </section>

  <script type="module">
    /* ---------- Firebase ---------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, query, where, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCieI_dFRI3K-TDNy0JFe02ndbT2ZO4bag",
      authDomain: "a-to-z-daily-account.firebaseapp.com",
      projectId: "a-to-z-daily-account",
      storageBucket: "a-to-z-daily-account.firebasestorage.app",
      messagingSenderId: "248686153632",
      appId: "1:248686153632:web:4399b9f34b0c97ae46dec5"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* ---------- Utils ---------- */
    const $ = (id)=>document.getElementById(id);
    const fmtINR = (n)=>new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR'}).format(+n||0);
    function todayIST(){
      const now = new Date();
      const utc = now.getTime() + now.getTimezoneOffset()*60000;
      const ist = new Date(utc + 5.5*3600000);
      const y=ist.getFullYear(), m=String(ist.getMonth()+1).padStart(2,"0"), d=String(ist.getDate()).padStart(2,"0");
      return `${y}-${m}-${d}`;
    }
    function showError(e){ $("errText").textContent = e?.message || e; $("errBar").classList.remove("hidden"); setTimeout(()=>$("errBar").classList.add("hidden"), 5000); }

    $("todayText").textContent = new Date().toLocaleString('en-IN',{timeZone:'Asia/Kolkata',weekday:'long',day:'2-digit',month:'long',year:'numeric'});

    // Default dates
    ["expenseDate","incomeDate"].forEach(id=>$(id).value = todayIST());

    // Categories (can edit later)
    const expenseCategories = ["Food Expenses","Fuel Expenses","Material Purchases","Miscellaneous","Repair","Stationery","Labour"];
    const incomeCategories  = ["Packers & Movers","Courier Services","Railway Ticket","Flight Ticket","PAN Services","Other Services"];
    $("expenseCategory").innerHTML = `<option value="">Category</option>` + expenseCategories.map(x=>`<option>${x}</option>`).join("");
    $("incomeCategory").innerHTML  = `<option value="">Category</option>` + incomeCategories.map(x=>`<option>${x}</option>`).join("");

    /* ---------- Tabs ---------- */
    document.querySelectorAll(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".tab").forEach(b=>b.classList.remove("tab-active"));
        btn.classList.add("tab-active");
        ["expenses","income"].forEach(id=>$(id).classList.add("hidden"));
        $(btn.dataset.tab).classList.remove("hidden");
      });
    });

    /* ---------- Auth ---------- */
    $("btnSignIn").addEventListener("click", async ()=>{
      $("authMsg").textContent="";
      try{
        await signInWithEmailAndPassword(auth, $("email").value.trim(), $("password").value);
      }catch(e){ $("authMsg").textContent = e?.message || "Sign-in failed"; }
    });
    $("btnSignOutTop").addEventListener("click", ()=>signOut(auth).catch(showError));

    onAuthStateChanged(auth, (user)=>{
      if(user){
        $("whoami").textContent = user.email;
        $("authCard").classList.add("hidden");
        $("app").classList.remove("hidden");
        $("btnSignOutTop").classList.remove("hidden");
        // start realtime for today's date (IST)
        startRealtime(todayIST());
      }else{
        $("authCard").classList.remove("hidden");
        $("app").classList.add("hidden");
        $("btnSignOutTop").classList.add("hidden");
      }
    });

    /* ---------- Realtime lists (today only for simplicity) ---------- */
    let unE=null, unI=null;
    function startRealtime(dateStr){
      if(unE)unE(); if(unI)unI();
      unE = onSnapshot(query(collection(db,"expenses"), where("date","==",dateStr)), (snap)=>{
        const items = snap.docs.map(d=>({id:d.id, ...d.data()}));
        renderList($("expensesList"), items, "expense");
      }, showError);
      unI = onSnapshot(query(collection(db,"income"), where("date","==",dateStr)), (snap)=>{
        const items = snap.docs.map(d=>({id:d.id, ...d.data()}));
        renderList($("incomesList"), items, "income");
      }, showError);
    }

    function renderList(container, arr, type){
      container.innerHTML = "";
      arr.sort((a,b)=>(a.updatedAt?.seconds||0)-(b.updatedAt?.seconds||0));
      arr.forEach(it=>{
        const isExpense = (type==="expense");
        const shownAmt  = Number(it.amount||0);
        const colorCls  = isExpense ? "text-expense" : "text-income";
        const row = document.createElement("div");
        row.className = "border rounded-xl px-3 py-2";
        row.innerHTML = `
          <div class="flex justify-between items-center gap-3">
            <div class="text-sm">
              <div class="font-semibold">${it.category||"-"}</div>
              <div class="text-slate-500">${new Date(it.date).toLocaleDateString('en-IN')} â€¢ ${it.payment||"-"}</div>
              <div class="text-slate-700">${it.description||""}</div>
            </div>
            <div class="text-right ${colorCls} font-bold">${fmtINR(shownAmt)}</div>
          </div>`;
        container.appendChild(row);
      });
    }

    /* ---------- Add & Notify helpers ---------- */
    function wa(text){ window.open(`https://wa.me/919338888550?text=${encodeURIComponent(text)}`,"_blank"); }
    function professionalMessage(kind, item){
      // WhatsApp uses *bold*, _italics_; keep lines tight & aligned
      return [
        `*${kind.toUpperCase()} ENTRY*`,
        `ðŸ“… *Date:* ${item.date}`,
        `ðŸ“‚ *Category:* ${item.category}`,
        `ðŸ’µ *Amount:* ${fmtINR(item.amount)}`,
        `ðŸ’³ *Mode:* ${item.payment}`,
        `ðŸ“ *Note:* ${item.description || '-'}`,
      ].join('\n');
    }

    async function addExpense(notify=false){
      const item={
        date:$("expenseDate").value || todayIST(),
        category:$("expenseCategory").value,
        payment:$("expensePayment").value,
        description:$("expenseDescription").value,
        amount:+$("expenseAmount").value,
        updatedAt:serverTimestamp(),
        updatedBy:auth.currentUser?.email
      };
      if(!item.category || !item.payment || !item.amount) return showError("Expense: Category, Mode, Amount are required.");
      await addDoc(collection(db,"expenses"), item);
      if(notify) wa(professionalMessage("Expense", item));
      // keep values except amount/desc to speed entry
      $("expenseAmount").value=""; $("expenseDescription").value="";
    }

    async function addIncome(notify=false){
      const item={
        date:$("incomeDate").value || todayIST(),
        category:$("incomeCategory").value,
        payment:$("incomePayment").value,
        description:$("incomeDescription").value,
        amount:+$("incomeAmount").value,
        updatedAt:serverTimestamp(),
        updatedBy:auth.currentUser?.email
      };
      if(!item.category || !item.payment || !item.amount) return showError("Income: Category, Mode, Amount are required.");
      await addDoc(collection(db,"income"), item);
      if(notify) wa(professionalMessage("Income", item));
      $("incomeAmount").value=""; $("incomeDescription").value="";
    }

    /* ---------- Form bindings ---------- */
    $("expenseForm").addEventListener("submit",(e)=>{e.preventDefault(); addExpense(false);});
    $("btnExpenseNotify").addEventListener("click",()=>addExpense(true));
    $("incomeForm").addEventListener("submit",(e)=>{e.preventDefault(); addIncome(false);});
    $("btnIncomeNotify").addEventListener("click",()=>addIncome(true));
  </script>
</body>
</html>